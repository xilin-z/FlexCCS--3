<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexCCS - Advanced CCS System Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #7CB9E8;
            --secondary-color: #F0F8FF;
            --text-color: #333;
            --gradient-start: #7CB9E8;
            --gradient-end: #4A90E2;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .calculator-panel {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .results {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, var(--primary-color), var(--gradient-end));
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .advanced-panel {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            margin-top: 30px;
        }

        .tab-container {
            margin-top: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            background: #e9ecef;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 4px 4px;
        }

        .tab-content.active {
            display: block;
        }

        .markdown-content {
            padding: 20px;
            line-height: 1.6;
        }

        .risk-indicators {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .gauge-chart {
            height: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .analysis-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analysis-button.active {
            background: var(--gradient-end);
            transform: scale(1.05);
        }

        .analysis-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .ai-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .ai-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container {
            height: 300px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FlexCCS - Advanced CCS System Calculator</h1>
        <p style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Developer: Xilin Zheng</p>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="showTab('basic')">Basic Calculator</button>
            <button class="tab-button" onclick="showTab('advanced')">Advanced ENPV Analysis</button>
            <button class="tab-button" onclick="showTab('ai')">AI Analysis</button>
        </div>

        <div id="basic-tab" class="tab-content active">
            <div class="grid-container">
                <!-- Capture Parameters -->
                <div class="calculator-panel">
                    <h2>Capture Parameters</h2>
                    <div class="input-group">
                        <label>Capture Technology</label>
                        <select id="captureType" onchange="updateCaptureInputs()">
                            <option value="chemical">Chemical Absorption</option>
                            <option value="physical">Physical Absorption</option>
                            <option value="membrane">Membrane Separation</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Major Equipment Cost (USD)</label>
                        <input type="number" id="equipmentCost" value="1000000" step="100000">
                    </div>
                    <div class="input-group">
                        <label>Lang Factor (K)</label>
                        <input type="number" id="langFactor" value="4.74" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>O&M Factor (%)</label>
                        <input type="number" id="omFactor" value="5" step="0.1" min="0" max="100">
                    </div>
                </div>

                <!-- Transport Parameters -->
                <div class="calculator-panel">
                    <h2>Transport Parameters</h2>
                    <div class="input-group">
                        <label>Transport Method</label>
                        <select id="transportType" onchange="updateTransportInputs()">
                            <option value="pipeline">Pipeline</option>
                            <option value="vessel">Vessel</option>
                        </select>
                    </div>
                    <div id="pipelineInputs">
                        <div class="input-group">
                            <label>Pipeline Length (L, km)</label>
                            <input type="number" id="pipeLength" value="0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Mass Flow (m, t/day)</label>
                            <input type="number" id="massFlow" value="0" step="0.1">
                        </div>
                    </div>
                    <div id="vesselInputs" style="display:none">
                        <div class="input-group">
                            <label>Ship CAPEX (USD)</label>
                            <input type="number" id="shipCapex" value="0" step="1000000">
                        </div>
                        <div class="input-group">
                            <label>Booster CAPEX (USD)</label>
                            <input type="number" id="boosterCapex" value="0" step="100000">
                        </div>
                        <div class="input-group">
                            <label>Tank Cost (USD)</label>
                            <input type="number" id="tankCost" value="0" step="100000">
                        </div>
                        <div class="input-group">
                            <label>Transport Distance (km)</label>
                            <input type="number" id="vesselDistance" value="0" step="1">
                        </div>
                        <div class="input-group">
                            <label>Fuel Cost (USD/km)</label>
                            <input type="number" id="fuelCost" value="0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Injection Parameters -->
                <div class="calculator-panel">
                    <h2>Injection Parameters</h2>
                    <div class="input-group">
                        <label>Well Depth (d, m)</label>
                        <input type="number" id="wellDepth" value="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>Well Count (N)</label>
                        <input type="number" id="wellCount" value="1" step="1">
                    </div>
                    <div class="input-group">
                        <label>Press-in Equipment Type</label>
                        <select id="pressInType">
                            <option value="none">None</option>
                            <option value="land">Land Press-in Equipment</option>
                            <option value="sea">Sea Press-in Equipment</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Equipment Coating Cost (USD)</label>
                        <input type="number" id="coatingCost" value="0" step="1000">
                    </div>
                </div>

                <!-- Storage Parameters -->
                <div class="calculator-panel">
                    <h2>Storage Parameters</h2>
                    <div class="input-group">
                        <label>CO₂ Storage Volume (V, Mt)</label>
                        <input type="number" id="storageVolume" value="0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Reservoir Depth (D, m)</label>
                        <input type="number" id="reservoirDepth" value="0" step="1">
                    </div>
                </div>

                <!-- Regulatory Parameters -->
                <div class="calculator-panel">
                    <h2>Regulatory Parameters</h2>
                    <div class="input-group">
                        <label>Carbon Price (P₁, USD/ton)</label>
                        <input type="number" id="carbonPrice" value="50" step="1">
                    </div>
                    <div class="input-group">
                        <label>Subsidy Rate (P₂, %)</label>
                        <input type="number" id="subsidyRate" value="30" step="1" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label>Environmental Liability Insurance Rate (P₃, %)</label>
                        <input type="number" id="insuranceRate" value="2" step="0.1" min="0" max="10">
                    </div>
                </div>
            </div>

            <button onclick="calculateBasicCosts()">Calculate Basic Costs</button>

            <div class="results" id="basic-results">
                <h2>Basic Calculation Results</h2>
                <p>Capture Efficiency: <span id="captureEfficiency">-</span>%</p>
                <p>Capture CAPEX: <span id="captureCapex">-</span> USD</p>
                <p>Capture OPEX: <span id="captureOpex">-</span> USD/year</p>
                <p>Transport CAPEX: <span id="transportCapex">-</span> USD</p>
                <p>Transport OPEX: <span id="transportOpex">-</span> USD/year</p>
                <p>Injection CAPEX: <span id="injectionCapex">-</span> USD</p>
                <p>Storage CAPEX: <span id="storageCapex">-</span> USD</p>
                <p>Total CAPEX: <span id="totalCapex">-</span> USD</p>
                <p>Total OPEX: <span id="totalOpex">-</span> USD/year</p>
                <p>Policy Adaptability Index: <span id="policyAdaptability">-</span></p>
            </div>
        </div>

        <div id="advanced-tab" class="tab-content">
            <div class="calculator-panel advanced-panel">
                <h2>Advanced ENPV Parameters (Machine Learning Optimization)</h2>
                <div class="grid-container">
                    <div class="input-group">
                        <label>β₁ (Penetration-driven Modular Investment)</label>
                        <input type="number" id="beta1" value="0.55" step="0.01" min="0" max="2">
                    </div>
                    <div class="input-group">
                        <label>β₂ (Power Cost Sensitivity Strategy)</label>
                        <input type="number" id="beta2" value="0.62" step="0.01" min="0" max="2">
                    </div>
                    <div class="input-group">
                        <label>β₃ (Carbon Price Fluctuation & Subsidy Decay)</label>
                        <input type="number" id="beta3" value="0.78" step="0.01" min="0" max="2">
                    </div>
                    <div class="input-group">
                        <label>γ (Cross-term Coefficient, Sobol Analysis)</label>
                        <input type="number" id="gamma" value="0.12" step="0.01" min="0" max="1">
                    </div>
                    <div class="input-group">
                        <label>Stakeholder Type</label>
                        <select id="alphaType">
                            <option value="gov">Government Agency (0.8-1.2)</option>
                            <option value="company">Energy Company (1.0-1.5)</option>
                            <option value="community">Community Representative (0.1-0.6)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Project Duration (years)</label>
                        <input type="number" id="projectDuration" value="20" step="1" min="1">
                    </div>
                    <div class="input-group">
                        <label>Discount Rate (%)</label>
                        <input type="number" id="discountRate" value="8" step="0.1" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label>Annual Operation Days</label>
                        <input type="number" id="operationDays" value="330" step="1" min="1" max="365">
                    </div>
                    <div class="input-group">
                        <label>Risk Factor (%)</label>
                        <input type="number" id="riskFactor" value="5" step="0.1" min="0" max="100">
                    </div>
                </div>
            </div>

            <button onclick="calculateAdvancedENPV()">Calculate Advanced ENPV</button>

            <div class="results" id="advanced-results">
                <h2>Advanced Calculation Results</h2>
                <p>Flexibility Premium (εt): <span id="epsilonT">-</span></p>
                <p>Sobol Sensitivity Index: <span id="sobolIndex">-</span></p>
                <p>Net Present Value (NPV): <span id="npv">-</span> USD</p>
                <p>Carbon Reduction Benefit: <span id="carbonBenefit">-</span> USD</p>
                <p>Subsidy Benefit: <span id="subsidyBenefit">-</span> USD</p>
                <p>Insurance Cost: <span id="insuranceCost">-</span> USD</p>
                <p>Payback Period: <span id="paybackPeriod">-</span> years</p>
                <p>Internal Rate of Return (IRR): <span id="irr">-</span>%</p>
                <p>Environmental Net Present Value (ENPV): <span id="enpv">-</span> USD</p>
            </div>
        </div>

        <div id="ai-tab" class="tab-content">
            <div class="analysis-selector">
                <button class="analysis-button active" onclick="showAnalysis('technical')">Technical Analysis</button>
                <button class="analysis-button" onclick="showAnalysis('economic')">Economic Analysis</button>
                <button class="analysis-button" onclick="showAnalysis('risk')">Risk Assessment</button>
                <button class="analysis-button" onclick="showAnalysis('comprehensive')">Comprehensive Analysis</button>
            </div>

            <div class="ai-dashboard">
                <div class="ai-card">
                    <h2>Analysis Dashboard</h2>
                    <div class="chart-container" id="mainChart"></div>
                </div>

                <div class="ai-card">
                    <h2>Key Metrics</h2>
                    <div class="chart-container" id="metricsChart"></div>
                </div>

                <div class="ai-card">
                    <h2>Trend Analysis</h2>
                    <div class="chart-container" id="trendChart"></div>
                </div>

                <div class="ai-card">
                    <h2>Recommendations</h2>
                    <div id="recommendationsPanel"></div>
                </div>
            </div>

            <div class="analysis-content" id="analysisContent"></div>
        </div>
    </div>

    <script>
        // Analysis Templates Definition
        const analysisTemplates = {
            technical: `Technical Analysis includes:
            1. Technology Maturity Radar Chart
            2. Cost Competitiveness Matrix
            3. Operation Reliability Index`,
            
            economic: `Economic Analysis includes:
            1. Dynamic Financial Model
            2. Sensitivity Butterfly Chart
            3. Carbon Credit Cash Flow Forecast`,
            
            risk: `Risk Assessment includes:
            1. Risk Heat Map
            2. Monte Carlo Simulation
            3. Stress Test Scenarios`,
            
            comprehensive: `Comprehensive Analysis Integration:
            1. Technical-Economic 3D Model
            2. Risk-Adjusted Rate of Return
            3. Sustainability Index`
        };

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'ai') {
                setTimeout(() => {
                    showAnalysis('technical');
                }, 100);
            }
        }

        function updateTransportInputs() {
            const transportType = document.getElementById('transportType').value;
            document.getElementById('pipelineInputs').style.display = transportType === 'pipeline' ? 'block' : 'none';
            document.getElementById('vesselInputs').style.display = transportType === 'vessel' ? 'block' : 'none';
        }

        function calculateBasicCosts() {
            // Get basic parameters
            const equipmentCost = parseFloat(document.getElementById('equipmentCost').value);
            const langFactor = parseFloat(document.getElementById('langFactor').value);
            const omFactor = parseFloat(document.getElementById('omFactor').value) / 100;
            const captureType = document.getElementById('captureType').value;

            // Calculate capture efficiency and costs
            let captureEfficiency;
            switch(captureType) {
                case 'chemical':
                    captureEfficiency = 0.90;
                    break;
                case 'physical':
                    captureEfficiency = 0.85;
                    break;
                case 'membrane':
                    captureEfficiency = 0.80;
                    break;
                default:
                    captureEfficiency = 0.85;
            }

            const captureCapex = equipmentCost * langFactor;
            const captureOpex = captureCapex * omFactor;

            // Calculate transport costs
            const transportType = document.getElementById('transportType').value;
            let transportCapex = 0;
            let transportOpex = 0;

            if (transportType === 'pipeline') {
                const pipeLength = parseFloat(document.getElementById('pipeLength').value);
                const massFlow = parseFloat(document.getElementById('massFlow').value);
                transportCapex = 9970 * Math.pow(massFlow, 0.35) * Math.pow(pipeLength, 0.13) * pipeLength;
                transportOpex = transportCapex * 0.05;
            } else {
                const shipCapex = parseFloat(document.getElementById('shipCapex').value);
                const boosterCapex = parseFloat(document.getElementById('boosterCapex').value);
                const tankCost = parseFloat(document.getElementById('tankCost').value);
                const distance = parseFloat(document.getElementById('vesselDistance').value);
                const fuelCost = parseFloat(document.getElementById('fuelCost').value);
                
                transportCapex = shipCapex + boosterCapex + tankCost;
                transportOpex = transportCapex * 0.05 + fuelCost * distance;
            }

            // Calculate injection costs
            const wellDepth = parseFloat(document.getElementById('wellDepth').value);
            const wellCount = parseInt(document.getElementById('wellCount').value);
            const pressInType = document.getElementById('pressInType').value;
            const coatingCost = parseFloat(document.getElementById('coatingCost').value);

            let injectionCapex = wellCount * (-3.9e-8 * Math.pow(wellDepth, 3) + 4.0e-4 * Math.pow(wellDepth, 2) - 0.84 * wellDepth + 903) * wellDepth;
            if (pressInType === 'land') {
                injectionCapex += 80000000;
            } else if (pressInType === 'sea') {
                injectionCapex += 100000000;
            }
            injectionCapex += coatingCost;

            // Calculate storage costs
            const storageVolume = parseFloat(document.getElementById('storageVolume').value);
            const reservoirDepth = parseFloat(document.getElementById('reservoirDepth').value);
            const storageCapex = 1000000 + 100 * storageVolume + 0.083 * Math.pow(reservoirDepth, 2);

            // Calculate total costs
            const totalCapex = captureCapex + transportCapex + injectionCapex + storageCapex;
            const totalOpex = captureOpex + transportOpex;

            // Calculate policy adaptability index
            const carbonPrice = parseFloat(document.getElementById('carbonPrice').value);
            const subsidyRate = parseFloat(document.getElementById('subsidyRate').value) / 100;
            const insuranceRate = parseFloat(document.getElementById('insuranceRate').value) / 100;

            const policyAdaptability = (carbonPrice / 100) * 0.4 + subsidyRate * 0.4 + (1 - insuranceRate) * 0.2;

            // Update basic results display
            document.getElementById('captureEfficiency').textContent = (captureEfficiency * 100).toFixed(2);
            document.getElementById('captureCapex').textContent = captureCapex.toFixed(2);
            document.getElementById('captureOpex').textContent = captureOpex.toFixed(2);
            document.getElementById('transportCapex').textContent = transportCapex.toFixed(2);
            document.getElementById('transportOpex').textContent = transportOpex.toFixed(2);
            document.getElementById('injectionCapex').textContent = injectionCapex.toFixed(2);
            document.getElementById('storageCapex').textContent = storageCapex.toFixed(2);
            document.getElementById('totalCapex').textContent = totalCapex.toFixed(2);
            document.getElementById('totalOpex').textContent = totalOpex.toFixed(2);
            document.getElementById('policyAdaptability').textContent = policyAdaptability.toFixed(2);
        }

        function calculateAdvancedENPV() {
            // Get advanced parameters
            const beta1 = parseFloat(document.getElementById('beta1').value);
            const beta2 = parseFloat(document.getElementById('beta2').value);
            const beta3 = parseFloat(document.getElementById('beta3').value);
            const gamma = parseFloat(document.getElementById('gamma').value);
            const alphaType = document.getElementById('alphaType').value;
            const projectDuration = parseInt(document.getElementById('projectDuration').value);
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            const operationDays = parseInt(document.getElementById('operationDays').value);
            const riskFactor = parseFloat(document.getElementById('riskFactor').value) / 100;

            // Get basic costs
            const totalCapex = parseFloat(document.getElementById('totalCapex').textContent);
            const totalOpex = parseFloat(document.getElementById('totalOpex').textContent);
            const carbonPrice = parseFloat(document.getElementById('carbonPrice').value);
            const subsidyRate = parseFloat(document.getElementById('subsidyRate').value) / 100;
            const insuranceRate = parseFloat(document.getElementById('insuranceRate').value) / 100;

            // Calculate flexibility premium
            let alpha;
            switch(alphaType) {
                case 'gov':
                    alpha = 1.0;
                    break;
                case 'company':
                    alpha = 1.2;
                    break;
                case 'community':
                    alpha = 0.4;
                    break;
                default:
                    alpha = 1.0;
            }

            const epsilonT = alpha * (beta1 + beta2 + beta3) * gamma;
            const sobolIndex = (beta1 * beta2 * beta3) / (beta1 + beta2 + beta3);

            // Calculate NPV components
            const annualCarbonReduction = totalCapex * 0.0001 * operationDays;
            const carbonBenefit = annualCarbonReduction * carbonPrice * projectDuration;
            const subsidyBenefit = totalCapex * subsidyRate;
            const insuranceCost = totalCapex * insuranceRate * projectDuration;

            // Calculate NPV
            let npv = -totalCapex;
            for (let t = 1; t <= projectDuration; t++) {
                const cashFlow = carbonBenefit/projectDuration + subsidyBenefit/projectDuration - totalOpex - insuranceCost/projectDuration;
                npv += cashFlow / Math.pow(1 + discountRate, t);
            }

            // Calculate ENPV with flexibility premium and risk adjustment
            const enpv = npv * (1 + epsilonT) * (1 - riskFactor);

            // Calculate IRR
            let irr = 0;
            const irrStep = 0.001;
            const maxIterations = 1000;
            let iterations = 0;

            while (iterations < maxIterations) {
                let npvAtIrr = -totalCapex;
                for (let t = 1; t <= projectDuration; t++) {
                    const cashFlow = carbonBenefit/projectDuration + subsidyBenefit/projectDuration - totalOpex - insuranceCost/projectDuration;
                    npvAtIrr += cashFlow / Math.pow(1 + irr, t);
                }
                
                if (Math.abs(npvAtIrr) < 1000) break;
                if (npvAtIrr > 0) {
                    irr += irrStep;
                } else {
                    irr -= irrStep;
                    break;
                }
                iterations++;
            }

            // Calculate payback period
            const annualNetCashFlow = carbonBenefit/projectDuration + subsidyBenefit/projectDuration - totalOpex - insuranceCost/projectDuration;
            const paybackPeriod = totalCapex / annualNetCashFlow;

            // Update advanced results display
            document.getElementById('epsilonT').textContent = epsilonT.toFixed(4);
            document.getElementById('sobolIndex').textContent = sobolIndex.toFixed(4);
            document.getElementById('npv').textContent = npv.toFixed(2);
            document.getElementById('carbonBenefit').textContent = carbonBenefit.toFixed(2);
            document.getElementById('subsidyBenefit').textContent = subsidyBenefit.toFixed(2);
            document.getElementById('insuranceCost').textContent = insuranceCost.toFixed(2);
            document.getElementById('paybackPeriod').textContent = paybackPeriod.toFixed(2);
            document.getElementById('irr').textContent = (irr * 100).toFixed(2);
            document.getElementById('enpv').textContent = enpv.toFixed(2);
        }

        function showAnalysis(type) {
            // Update button states
            document.querySelectorAll('.analysis-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`button[onclick="showAnalysis('${type}')"]`).classList.add('active');

            // Update analysis content
            const content = document.getElementById('analysisContent');
            content.innerHTML = marked.parse(analysisTemplates[type]);

            // Update charts based on analysis type
            updateCharts(type);
        }

        function updateCharts(analysisType) {
            switch(analysisType) {
                case 'technical':
                    updateTechnicalCharts();
                    break;
                case 'economic':
                    updateEconomicCharts();
                    break;
                case 'risk':
                    updateRiskCharts();
                    break;
                case 'comprehensive':
                    updateComprehensiveCharts();
                    break;
            }
        }

        function updateTechnicalCharts() {
            // Main Chart - Technology Maturity Radar
            const mainChart = echarts.init
            document.getElementById('totalCapex').textContent = totalCapex.toFixed(2);
            document.getElementById('totalOpex').textContent = totalOpex.toFixed(2);
            document.getElementById('policyAdaptability').textContent = policyAdaptability.toFixed(2);
        }

        function calculateAdvancedENPV() {
            // Get basic costs from previous calculation
            const totalCapex = parseFloat(document.getElementById('totalCapex').textContent);
            const totalOpex = parseFloat(document.getElementById('totalOpex').textContent);
            const captureEfficiency = parseFloat(document.getElementById('captureEfficiency').textContent) / 100;

            // Get advanced parameters
            const beta1 = parseFloat(document.getElementById('beta1').value);
            const beta2 = parseFloat(document.getElementById('beta2').value);
            const beta3 = parseFloat(document.getElementById('beta3').value);
            const gamma = parseFloat(document.getElementById('gamma').value);
            const alphaType = document.getElementById('alphaType').value;
            const projectDuration = parseInt(document.getElementById('projectDuration').value);
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            const operationDays = parseInt(document.getElementById('operationDays').value);
            const riskFactor = parseFloat(document.getElementById('riskFactor').value) / 100;

            // Get regulatory parameters
            const carbonPrice = parseFloat(document.getElementById('carbonPrice').value);
            const subsidyRate = parseFloat(document.getElementById('subsidyRate').value) / 100;
            const insuranceRate = parseFloat(document.getElementById('insuranceRate').value) / 100;

            // Calculate alpha based on stakeholder type
            let alpha;
            switch(alphaType) {
                case 'gov':
                    alpha = 0.8 + Math.random() * 0.4;
                    break;
                case 'company':
                    alpha = 1.0 + Math.random() * 0.5;
                    break;
                case 'community':
                    alpha = 0.1 + Math.random() * 0.5;
                    break;
                default:
                    alpha = 1.0;
            }

            // Calculate flexibility premium (εt)
            const epsilonT = beta1 * Math.pow(captureEfficiency, 2) + 
                           beta2 * Math.log(totalCapex/1e6) + 
                           beta3 * carbonPrice/100 + 
                           gamma * alpha;

            // Calculate Sobol sensitivity index
            const sobolIndex = (beta1 + beta2 + beta3) / (1 + gamma * alpha);

            // Calculate annual cash flows
            let npv = -totalCapex;
            let carbonBenefit = 0;
            let subsidyBenefit = 0;
            let insuranceCost = 0;

            for(let t = 1; t <= projectDuration; t++) {
                // Calculate benefits
                const yearlyCarbon = operationDays * captureEfficiency * 1000; // tons of CO2
                const carbonBenefitYear = yearlyCarbon * carbonPrice;
                const subsidyBenefitYear = totalCapex * subsidyRate / projectDuration;
                
                // Calculate costs
                const opexYear = totalOpex * Math.pow(1 + riskFactor, t-1);
                const insuranceCostYear = totalCapex * insuranceRate;

                // Calculate net cash flow for the year
                const netCashFlow = (carbonBenefitYear + subsidyBenefitYear - opexYear - insuranceCostYear) * 
                                  Math.pow(epsilonT, t/projectDuration);

                // Update NPV
                npv += netCashFlow / Math.pow(1 + discountRate, t);

                // Update cumulative values
                carbonBenefit += carbonBenefitYear / Math.pow(1 + discountRate, t);
                subsidyBenefit += subsidyBenefitYear / Math.pow(1 + discountRate, t);
                insuranceCost += insuranceCostYear / Math.pow(1 + discountRate, t);
            }

            // Calculate IRR using Newton's method
            let irr = 0.1; // Initial guess
            const maxIterations = 100;
            const tolerance = 0.0001;
            
            for(let i = 0; i < maxIterations; i++) {
                let f = -totalCapex;
                let fPrime = 0;
                
                for(let t = 1; t <= projectDuration; t++) {
                    const yearlyCarbon = operationDays * captureEfficiency * 1000;
                    const netCashFlow = (yearlyCarbon * carbonPrice + 
                                       totalCapex * subsidyRate / projectDuration - 
                                       totalOpex * Math.pow(1 + riskFactor, t-1) - 
                                       totalCapex * insuranceRate) * 
                                      Math.pow(epsilonT, t/projectDuration);
                    
                    f += netCashFlow / Math.pow(1 + irr, t);
                    fPrime -= t * netCashFlow / Math.pow(1 + irr, t + 1);
                }
                
                const delta = f / fPrime;
                irr -= delta;
                
                if(Math.abs(delta) < tolerance) break;
            }

            // Calculate payback period
            let cumulativeCashFlow = -totalCapex;
            let paybackPeriod = projectDuration;
            
            for(let t = 1; t <= projectDuration; t++) {
                const yearlyCarbon = operationDays * captureEfficiency * 1000;
                const netCashFlow = (yearlyCarbon * carbonPrice + 
                                   totalCapex * subsidyRate / projectDuration - 
                                   totalOpex * Math.pow(1 + riskFactor, t-1) - 
                                   totalCapex * insuranceRate) * 
                                  Math.pow(epsilonT, t/projectDuration);
                
                cumulativeCashFlow += netCashFlow;
                
                if(cumulativeCashFlow >= 0) {
                    paybackPeriod = t;
                    break;
                }
            }

            // Calculate ENPV
            const enpv = npv * Math.pow(sobolIndex, alpha);
        
        // ... existing code ...

function showAnalysis(type) {
    // Update button states
    document.querySelectorAll('.analysis-button').forEach(button => {
        button.classList.remove('active');
    });
    document.querySelector(`button[onclick="showAnalysis('${type}')"]`).classList.add('active');

    // Update charts based on analysis type
    updateMainChart(type);
    updateMetricsChart(type);
    updateTrendChart(type);
    updateRecommendations(type);
}

function updateMainChart(type) {
    const chart = echarts.init(document.getElementById('mainChart'));
    let option;

    switch(type) {
        case 'technical':
            option = {
                radar: {
                    indicator: [
                        { name: 'Technology Maturity', max: 100 },
                        { name: 'Operational Efficiency', max: 100 },
                        { name: 'Cost Effectiveness', max: 100 },
                        { name: 'Environmental Impact', max: 100 },
                        { name: 'Scalability', max: 100 }
                    ]
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [85, 90, 75, 95, 80],
                        name: 'Technical Assessment'
                    }]
                }]
            };
            break;

        case 'economic':
            option = {
                xAxis: {
                    type: 'category',
                    data: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5']
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [820, 932, 901, 934, 1290],
                    type: 'line',
                    name: 'Revenue'
                }, {
                    data: [620, 732, 701, 734, 890],
                    type: 'line',
                    name: 'Cost'
                }],
                legend: {
                    data: ['Revenue', 'Cost']
                }
            };
            break;

        case 'risk':
            option = {
                series: [{
                    type: 'gauge',
                    startAngle: 180,
                    endAngle: 0,
                    min: 0,
                    max: 100,
                    splitNumber: 8,
                    axisLine: {
                        lineStyle: {
                            width: 6,
                            color: [
                                [0.3, '#67e0e3'],
                                [0.7, '#37a2da'],
                                [1, '#fd666d']
                            ]
                        }
                    },
                    pointer: {
                        itemStyle: {
                            color: 'auto'
                        }
                    },
                    axisTick: {
                        distance: -30,
                        length: 8,
                        lineStyle: {
                            color: '#fff',
                            width: 2
                        }
                    },
                    splitLine: {
                        distance: -30,
                        length: 30,
                        lineStyle: {
                            color: '#fff',
                            width: 4
                        }
                    },
                    axisLabel: {
                        color: 'auto',
                        distance: -40,
                        fontSize: 12
                    },
                    detail: {
                        valueAnimation: true,
                        formatter: '{value}%',
                        color: 'auto'
                    },
                    data: [{
                        value: 70
                    }]
                }]
            };
            break;

        case 'comprehensive':
            option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['Technical', 'Economic', 'Environmental']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: [
                    {
                        type: 'category',
                        data: ['Q1', 'Q2', 'Q3', 'Q4']
                    }
                ],
                yAxis: [
                    {
                        type: 'value'
                    }
                ],
                series: [
                    {
                        name: 'Technical',
                        type: 'bar',
                        data: [320, 332, 301, 334]
                    },
                    {
                        name: 'Economic',
                        type: 'bar',
                        data: [220, 182, 191, 234]
                    },
                    {
                        name: 'Environmental',
                        type: 'bar',
                        data: [150, 232, 201, 154]
                    }
                ]
            };
            break;
    }

    chart.setOption(option);
}

function updateMetricsChart(type) {
    const chart = echarts.init(document.getElementById('metricsChart'));
    let option;

    switch(type) {
        case 'technical':
            option = {
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: 35, name: 'Capture Efficiency' },
                        { value: 30, name: 'Energy Consumption' },
                        { value: 20, name: 'Equipment Reliability' },
                        { value: 15, name: 'Process Control' }
                    ]
                }]
            };
            break;

        case 'economic':
            option = {
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: 40, name: 'CAPEX' },
                        { value: 30, name: 'OPEX' },
                        { value: 20, name: 'Carbon Credits' },
                        { value: 10, name: 'Subsidies' }
                    ]
                }]
            };
            break;

        case 'risk':
            option = {
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: 30, name: 'Technical Risk' },
                        { value: 25, name: 'Market Risk' },
                        { value: 25, name: 'Policy Risk' },
                        { value: 20, name: 'Operational Risk' }
                    ]
                }]
            };
            break;

        case 'comprehensive':
            option = {
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: 35, name: 'Technical Score' },
                        { value: 30, name: 'Economic Score' },
                        { value: 20, name: 'Environmental Score' },
                        { value: 15, name: 'Social Score' }
                    ]
                }]
            };
            break;
    }

    chart.setOption(option);
}

function updateTrendChart(type) {
    const chart = echarts.init(document.getElementById('trendChart'));
    let option;

    switch(type) {
        case 'technical':
            option = {
                xAxis: {
                    type: 'category',
                    data: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [90, 92, 91, 94, 95, 93],
                    type: 'line',
                    name: 'Performance'
                }]
            };
            break;

        case 'economic':
            option = {
                xAxis: {
                    type: 'category',
                    data: ['2023', '2024', '2025', '2026', '2027']
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [100, 120, 140, 160, 180],
                    type: 'line',
                    name: 'ROI Trend'
                }]
            };
            break;

        case 'risk':
            option = {
                xAxis: {
                    type: 'category',
                    data: ['Q1', 'Q2', 'Q3', 'Q4']
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [30, 25, 20, 15],
                    type: 'line',
                    name: 'Risk Level'
                }]
            };
            break;

        case 'comprehensive':
            option = {
                xAxis: {
                    type: 'category',
                    data: ['2023', '2024', '2025', '2026', '2027']
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [70, 75, 80, 85, 90],
                    type: 'line',
                    name: 'Overall Score'
                }]
            };
            break;
    }

    chart.setOption(option);
}

function updateRecommendations(type) {
    const recommendations = {
        technical: `
            <h3>Technical Recommendations:</h3>
            <ul>
                <li>Optimize capture technology efficiency</li>
                <li>Implement advanced monitoring systems</li>
                <li>Enhance equipment maintenance protocols</li>
            </ul>
        `,
        economic: `
            <h3>Economic Recommendations:</h3>
            <ul>
                <li>Optimize carbon credit trading strategy</li>
                <li>Identify key areas for cost reduction</li>
                <li>Improve capital utilization efficiency</li>
            </ul>
        `,
        risk: `
            <h3>Risk Management Recommendations:</h3>
            <ul>
                <li>Establish comprehensive risk monitoring</li>
                <li>Develop contingency response plans</li>
                <li>Optimize insurance coverage</li>
            </ul>
        `,
        comprehensive: `
            <h3>Comprehensive Recommendations:</h3>
            <ul>
                <li>Balance technical upgrades with economic benefits</li>
                <li>Strengthen environmental impact management</li>
                <li>Enhance social value contribution</li>
            </ul>
        `
    };
    document.getElementById('recommendationsPanel').innerHTML = recommendations[type];
}

// Add window resize handler for charts
window.addEventListener('resize', function() {
    const charts = document.querySelectorAll('.chart-container');
    charts.forEach(container => {
        const chart = echarts.getInstanceByDom(container);
        if (chart) {
            chart.resize();
        }
    });
});

// Initialize the page
updateTransportInputs();

            //Update the results
            document.getElementById('epsilonT').textContent = epsilonT.toFixed(4);
            document.getElementById('sobolIndex').textContent = sobolIndex.toFixed(4);
            document.getElementById('npv').textContent = npv.toFixed(2);
            document.getElementById('carbonBenefit').textContent = carbonBenefit.toFixed(2);
            document.getElementById('subsidyBenefit').textContent = subsidyBenefit.toFixed(2);
            document.getElementById('insuranceCost').textContent = insuranceCost.toFixed(2);
            document.getElementById('paybackPeriod').textContent = paybackPeriod.toFixed(1);
            document.getElementById('irr').textContent = (irr * 100).toFixed(2);
            document.getElementById('enpv').textContent = enpv.toFixed(2);
        }
    </script>
</body>
</html>